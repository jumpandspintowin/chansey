#!/usr/bin/env ruby

require 'eventmachine'
require 'logger'
require 'trollop'
require 'yaml'

require 'chansey/irc_client/client'

def main(opts)
  # Set logging to be STDOUT if the log option is not specified
  log_file = opts[:logfile].empty? ? STDOUT : opts[:logfile]

  # Set the config file to default to 'config.yaml' in the same directory as this file
  config_file = opts[:config].empty? ? File.expand_path("../config.yaml", __FILE__) : opts[:config]

  # Start the logger and set the level
  log = Logger.new(log_file)
  log.level = opts[:debug] ? Logger::DEBUG : Logger::INFO

  # Load the configuration file
  config = YAML.load_file(config_file)

  begin
    EventMachine.run do
      irc_client = Chansey::IrcClient::Client.new(config['irc'], log)
      irc_client.connect('cognet')
    end

  # NOTE: Yes, this rescues Exception. This is intentional to log all fatals.
  rescue Exception => e
    log.fatal "FATAL Uncaught exception: #{e.exception}: #{e.message}\n#{e.backtrace.join("\n")}"
  end
end

opts = Trollop::options do
  opt :config, "Config file location", :short => "-c", :default => File.expand_path("../config.yaml", __FILE__)
  opt :debug, "Debug logging", :short => '-d'
  opt :logfile, "Log file location", :short => "-l", :default => ""
end

main opts
